<!DOCTYPE html>
<html>
<head>
  <title>Chat Application</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">
  <div class="card shadow p-4">

    <h3 class="mb-3">Chat Room</h3>

    <p id="welcome" class="fw-bold"></p>

    <select class="form-select mb-3" id="roomSelect">
      <option value="devops">DevOps</option>
      <option value="cloud">Cloud</option>
      <option value="sports">Sports</option>
      <option value="nodejs">NodeJS</option>
    </select>

    <select class="form-select mb-3" id="privateUser">
      <option value="">Private message to...</option>
    </select>

    <button id="joinBtn" class="btn btn-primary mb-2">Join Room</button>
    <button id="leaveBtn" class="btn btn-secondary mb-3">Leave Room</button>

    <div id="chatBox"
         class="border rounded p-3 mb-2 bg-white"
         style="height:300px; overflow-y:scroll;">
    </div>

    <div id="typingIndicator" class="text-muted mb-2"></div>

    <input id="messageInput"
           class="form-control mb-2"
           placeholder="Type message...">

    <button id="sendBtn" class="btn btn-success w-100">Send</button>

    <button id="logoutBtn" class="btn btn-danger mt-3 w-100">Logout</button>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const username = localStorage.getItem("username");

  if (!username) {
    window.location.href = "login.html";
    return;
  }

  const socket = io();
  let currentRoom = "";

  document.getElementById("welcome").innerText =
    "Logged in as: " + username;

  socket.emit("registerUser", username);

  socket.on("updateUserList", function(users) {

    const select = document.getElementById("privateUser");
    select.innerHTML = "<option value=''>Private message to...</option>";

    users.forEach(function(user) {
      if (user !== username) {
        select.innerHTML +=
          "<option value='" + user + "'>" + user + "</option>";
      }
    });

  });

  document.getElementById("joinBtn").addEventListener("click", function () {

    currentRoom = document.getElementById("roomSelect").value;

    document.getElementById("chatBox").innerHTML = "";

    socket.emit("joinRoom", currentRoom);

    alert("Joined room: " + currentRoom);
  });

  document.getElementById("leaveBtn").addEventListener("click", function () {

    if (!currentRoom) {
      alert("You are not in any room.");
      return;
    }

    socket.emit("leaveRoom", currentRoom);

    alert("Left room: " + currentRoom);

    document.getElementById("chatBox").innerHTML = "";
    currentRoom = "";
  });

  document.getElementById("sendBtn").addEventListener("click", function () {

    const message = document.getElementById("messageInput").value;
    const toUser = document.getElementById("privateUser").value;

    if (!message.trim()) return;

    if (toUser) {

      socket.emit("privateMessage", {
        from_user: username,
        to_user: toUser,
        message: message
      });

    } else {

      if (!currentRoom) {
        alert("Join a room first");
        return;
      }

      socket.emit("chatMessage", {
        from_user: username,
        room: currentRoom,
        message: message
      });

    }

    document.getElementById("messageInput").value = "";
  });

  document.getElementById("messageInput").addEventListener("input", function () {

    if (!currentRoom) return;

    socket.emit("typing", {
      username: username,
      room: currentRoom
    });
  });

  socket.on("typing", function(user) {

    const indicator = document.getElementById("typingIndicator");

    indicator.innerText = user + " is typing...";

    setTimeout(() => {
      indicator.innerText = "";
    }, 1500);
  });

  socket.on("loadMessages", function(messages) {

    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";

    messages.forEach(function(msg) {
      chatBox.innerHTML +=
        "<p><strong>" + msg.from_user +
        ":</strong> " + msg.message + "</p>";
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });

  socket.on("message", function(data) {

    const chatBox = document.getElementById("chatBox");

    chatBox.innerHTML +=
      "<p><strong>" + data.from_user +
      ":</strong> " + data.message + "</p>";

    chatBox.scrollTop = chatBox.scrollHeight;
  });

  socket.on("receivePrivate", function(data) {

    if (data.to_user === username ||
        data.from_user === username) {

      const chatBox = document.getElementById("chatBox");

      chatBox.innerHTML +=
        "<p style='color:purple'><strong>PRIVATE " +
        data.from_user + ":</strong> " +
        data.message + "</p>";

      chatBox.scrollTop = chatBox.scrollHeight;
    }

  });

  document.getElementById("logoutBtn")
    .addEventListener("click", function () {

      socket.disconnect();
      localStorage.clear();
      window.location.href = "login.html";
  });

});
</script>

</body>
</html>
